<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>JSMidi test suite</title>

<script type="text/javascript" src="http://yui.yahooapis.com/3.2.0/build/yui/yui-min.js"></script>
<script type="text/javascript" src="../midi.js"></script>

</head>

<body class="yui3-skin-sam  yui-skin-sam">
<div id="testLogger"></div>

<script type="text/javascript">
YUI().use("console", "test",function (Y) {

    var A = Y.Assert;

    var HDR_CHUNKID     = "MThd";
    var HDR_CHUNK_SIZE  = "\x00\x00\x00\x06"; // Header size for SMF
    var HDR_TYPE0       = "\x00\x00"; // Midi Type 0 id
    var HDR_TYPE1       = "\x00\x01"; // Midi Type 1 id
    var HDR_SPEED       = "\x00\x80"; // Defaults to 128 ticks per beat

    // Midi event codes
    var EVT_NOTE_OFF           = 0x8;
    var EVT_NOTE_ON            = 0x9;
    var EVT_AFTER_TOUCH        = 0xA;
    var EVT_CONTROLLER         = 0xB;
    var EVT_PROGRAM_CHANGE     = 0xC;
    var EVT_CHANNEL_AFTERTOUCH = 0xD;
    var EVT_PITCH_BEND         = 0xE;

    Y.namespace("jsmidi.test");

    Y.jsmidi.test.MidiTestCase = new Y.Test.Case({

        name: "Midi Class testcase",

        setUp : function () {
            this.evt1 = new MidiEvent({
                    time: 0,
                    type:    EVT_NOTE_ON,
                    channel: 0,
                    param1:  60,
                    param2:  10
                });
            this.evt2 = new MidiEvent({
                    time:    128,
                    type:    EVT_NOTE_OFF,
                    channel: 0,
                    param1:  60,
                    param2:  10
                });
        },


        testTranslateTickTime: function() {
            var ttt = translateTickTime;

            A.areEqual(127, ttt(127)[0]);

            var v2 = 255;
            A.areEqual(0x81, ttt(v2)[0]);
            A.areEqual(0x7f, ttt(v2)[1]);

            var v3 = 32768;
            A.areEqual(0x82, ttt(v3)[0]);
            A.areEqual(0x80, ttt(v3)[1]);
            A.areEqual(0x00, ttt(v3)[2]);

        },
        testMidiWriter: function() {
            var track = new MidiTrack([this.evt1, this.evt2]);
            var midiHex = MidiWriter({ tracks: [track] });

            var uri = "data:audio/x-midi;base64," + midiHex.b64;
            var audioEl = new Audio();
            //console.log(midiHex)
            audioEl.src = uri//"http://www.a1freesoundeffects.com/popular12008/sword.mp3";
            audioEl.play();
        }
    });

    Y.jsmidi.test.EventTestCase = new Y.Test.Case({

        name : "Midi events testcase",

        testCreateEmpty : function () {
            var event = new MidiEvent();

            A.isObject(event);
            A.isInstanceOf(MidiEvent, event);
            A.isArray(event.timeStamp);
            A.areEqual(0, event.timeStamp.length);
        },

        testCreateWithParams : function () {
            var event = new MidiEvent({
                    time:    128,
                    type:    EVT_NOTE_ON,
                    channel: 0,
                    param1:  0x3c,
                    param2:  28
                });

            A.isObject(event);
            A.isInstanceOf(MidiEvent, event);
            A.areEqual(EVT_NOTE_ON, event.type);
            A.areEqual(0, event.channel);
            A.areEqual(0x3c, event.param1);
            A.areEqual(28, event.param2);
            A.areEqual("8100903c1c", ArrayToHexString(event.toBytes()));

            var event2 = new MidiEvent({
                    time: 127,
                    type: EVT_NOTE_ON,
                    channel: 0,
                    param1: 0x3E,
                    param2: 0x60
                    })
            A.areEqual("7f903e60", ArrayToHexString(event2.toBytes()));
        },


    });

    Y.jsmidi.test.TrackTestCase = new Y.Test.Case({

        name : "Midi track testcase",

        setUp : function () {
            this.evt1 = new MidiEvent({
                    time: 0,
                    type:    EVT_NOTE_ON,
                    channel: 0,
                    param1:  60,
                    param2:  10
                });
            this.evt2 = new MidiEvent({
                    time:    128,
                    type:    EVT_NOTE_OFF,
                    channel: 0,
                    param1:  60,
                    param2:  10
                });
        },

        tearDown: function () {
            delete this.evt1;
        },

        testCreateEmpty: function () {
            var track = new MidiTrack();

            A.isObject(track);
            A.isInstanceOf(MidiTrack, track);
            A.isObject(track.events);
            A.areEqual(0, track.events.midi.length);
            A.areEqual(0, track.events.meta.length);
            A.areEqual(0, track.events.sysex.length);
            A.areEqual("4d54726b0000000000ff2f00", ArrayToHexString(track.toBytes()));
        },
        testCreateWithEvents: function() {
            var track = new MidiTrack([this.evt1, this.evt2]);
            A.areEqual("4d54726b0000000f00903c0a8100803c0a00ff2f00", ArrayToHexString(track.toBytes()));
        }
    });

    Y.jsmidi.test.Suite = new Y.Test.Suite("JSMidi Suite");
    Y.jsmidi.test.Suite.add(Y.jsmidi.test.MidiTestCase);
    Y.jsmidi.test.Suite.add(Y.jsmidi.test.EventTestCase);
    Y.jsmidi.test.Suite.add(Y.jsmidi.test.TrackTestCase);

    var r = new Y.Console({
        newestOnTop : false,
        style: 'block'
    });

    r.render('#testLogger');

    Y.Test.Runner.add(Y.jsmidi.test.Suite);
    Y.Test.Runner.run();
});
</script>

</body>
</html>
